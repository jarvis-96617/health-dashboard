<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·çœ‹æ¿">
    <title>å€‹äººå¥åº·å„€è¡¨æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --accent-red: #ff3b30;    /* æ´»å‹• */
            --accent-green: #34c759;  /* é‹å‹• */
            --accent-blue: #007aff;   /* ç«™ç«‹/ç¡çœ  */
            --accent-orange: #ff9500; /* æ­¥æ•¸ */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Heiti TC", "Microsoft JhengHei", sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            padding-top: 50px;
            -webkit-font-smoothing: antialiased;
        }

        /* å°èˆªåˆ‡æ›æŒ‰éˆ• */
        .nav-container {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-sub);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-item.active {
            background-color: #636366; /* é¸ä¸­æ™‚çš„ç°è‰²èƒŒæ™¯ */
            color: var(--text-main);
            font-weight: 700;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        p.date-label {
            color: var(--text-sub);
            font-size: 14px;
            margin-top: 0;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 18px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .card.full-width {
            grid-column: span 2;
        }

        .card-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 13px;
            color: var(--text-sub);
            font-weight: 600;
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 4px;
        }

        .card-unit {
            font-size: 14px;
            color: var(--text-sub);
            font-weight: 500;
            margin-left: 2px;
        }

        .move-text { color: var(--accent-red); }
        .exercise-text { color: var(--accent-green); }
        .stand-text { color: var(--accent-blue); }

        .loading {
            text-align: center;
            color: var(--text-sub);
            margin-top: 50px;
            line-height: 1.6;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: #333;
            font-size: 10px;
        }
        
        /* æ¨™ç±¤é¡¯ç¤º (ç¸½å’Œ/å¹³å‡) */
        .stat-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #3a3a3c;
            color: #fff;
            margin-left: 5px;
            vertical-align: middle;
            display: none; /* é è¨­éš±è—ï¼Œåªæœ‰é€±/æœˆé¡¯ç¤º */
        }
    </style>
</head>
<body>

    <div id="app">
        <h1>å¥åº·æ¦‚è¦½</h1>
        <p class="date-label" id="currentDate">è®€å–ä¸­...</p>

        <div class="nav-container">
            <div class="nav-item active" onclick="switchView('day')">ä»Šå¤©</div>
            <div class="nav-item" onclick="switchView('week')">æœ¬é€± (7å¤©)</div>
            <div class="nav-item" onclick="switchView('month')">æœ¬æœˆ (30å¤©)</div>
        </div>

        <div class="grid-container" id="dashboard" style="display:none;">
            
            <div class="card full-width">
                <div class="card-title">æ´»å‹•ç´€éŒ„ <span id="badge_activity" class="stat-type">ç¸½å’Œ</span></div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div>
                        <div class="card-value move-text" id="val_move">--</div>
                        <div class="card-unit">åƒå¡</div>
                    </div>
                    <div>
                        <div class="card-value exercise-text" id="val_exercise">--</div>
                        <div class="card-unit">åˆ†é˜</div>
                    </div>
                    <div>
                        <div class="card-value stand-text" id="val_stand">--</div>
                        <div class="card-unit">å°æ™‚</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">ğŸ‘£</div>
                <div>
                    <div class="card-title">æ­¥æ•¸ <span id="badge_steps" class="stat-type">ç¸½å’Œ</span></div>
                    <div class="card-value" id="val_steps">--</div>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">ğŸ“</div>
                <div>
                    <div class="card-title">è·é›¢ <span id="badge_dist" class="stat-type">ç¸½å’Œ</span></div>
                    <div class="card-value" id="val_dist">--<span class="card-unit">å…¬é‡Œ</span></div>
                </div>
            </div>

            <div class="card full-width">
                <div class="card-icon">ğŸ›Œ ç¡çœ åˆ†æ</div>
                <div style="display:flex; align-items:baseline;">
                    <div class="card-value" id="val_sleep">--</div>
                    <span class="card-unit">å°æ™‚ <span id="badge_sleep" class="stat-type">å¹³å‡</span></span>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">â¤ï¸ éœæ­¢å¿ƒç‡</div>
                <div>
                    <div class="card-title">RHR <span id="badge_rhr" class="stat-type">å¹³å‡</span></div>
                    <div class="card-value" id="val_rhr">--<span class="card-unit">BPM</span></div>
                </div>
            </div>

             <div class="card">
                <div class="card-icon">ğŸ’§ è¡€æ°§æ¿ƒåº¦</div>
                <div>
                    <div class="card-title">SpO2 <span id="badge_spo2" class="stat-type">å¹³å‡</span></div>
                    <div class="card-value" id="val_spo2">--<span class="card-unit">%</span></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-icon">âš¡ æ­¥è¡Œé€Ÿåº¦</div>
                <div>
                    <div class="card-title">é€Ÿåº¦ <span id="badge_speed" class="stat-type">å¹³å‡</span></div>
                    <div class="card-value" id="val_speed">--<span class="card-unit">km/h</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">ğŸ§  å¿ƒæƒ…</div>
                <div>
                    <div class="card-title">ç‹€æ…‹</div>
                    <div class="card-value" style="font-size: 20px;" id="val_mood">--</div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</div>
        <div class="footer">Data sourced from Apple Health via Google Sheets</div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆä½ çš„ Google Sheet CSV ç™¼å¸ƒç¶²å€ â˜…â˜…â˜…
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzsERhjCfnFkITb8kpEsFqmMcO9mnwswn2GBCLfqiCZSe_RLHTLWVYWIVvI09Pvp4BiYr-VaPqTrdj/pub?gid=1612153779&single=true&output=csv';

        let allData = []; // å„²å­˜æ‰€æœ‰è³‡æ–™
        let currentView = 'day'; // ç•¶å‰æ¨¡å¼: day, week, month

        function init() {
            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    // éæ¿¾æ‰æ²’æœ‰æ—¥æœŸçš„ç©ºè¡Œ
                    allData = data.filter(row => row.Date);

                    if (allData.length > 0) {
                        switchView('day'); // é è¨­é¡¯ç¤ºä»Šå¤©
                    } else {
                        showError("ç„¡è³‡æ–™", "CSV è®€å–æˆåŠŸä½†æ²’æœ‰å…§å®¹ã€‚");
                    }
                },
                error: function(err, file, inputElem, reason) {
                    console.error("Error:", err);
                    showError("è®€å–å¤±æ•—", "éŒ¯èª¤ä»£ç¢¼: " + JSON.stringify(err) + "<br>åŸå› : " + (reason || "Unknown"));
                }
            });
        }

        // åˆ‡æ›è¦–åœ–é‚è¼¯
        function switchView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.nav-item[onclick="switchView('${view}')"]`)[0].classList.add('active');

            // æº–å‚™æ•¸æ“š
            let displayData = {};
            
            if (view === 'day') {
                // å–æœ€æ–°ä¸€ç­†
                displayData = allData[allData.length - 1];
                updateBadgeDisplay('none');
                document.getElementById('currentDate').innerText = displayData.Date;
            } else {
                // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
                const days = (view === 'week') ? 7 : 30;
                // å–æœ€å¾Œ N ç­†è³‡æ–™ (å¦‚æœè³‡æ–™ä¸è¶³ N ç­†ï¼Œå°±å–å…¨éƒ¨)
                const sliceData = allData.slice(-days);
                displayData = calculateStats(sliceData);
                updateBadgeDisplay('inline-block');
                document.getElementById('currentDate').innerText = `éå» ${sliceData.length} å¤©çµ±è¨ˆ`;
            }

            renderDashboard(displayData);
        }

        // è¨ˆç®—ç¸½å’Œèˆ‡å¹³å‡
        function calculateStats(dataArray) {
            let stats = {
                Move_Cal: 0, Exercise_Min: 0, Stand_Hr: 0, Steps: 0, Distance: 0,
                Sleep_Hr: 0, RHR: 0, SpO2: 0, Walking_Speed: 0, Mood: ''
            };
            
            let count = dataArray.length;
            let sleepCount = 0, rhrCount = 0, spo2Count = 0, speedCount = 0;

            // ç´¯åŠ 
            dataArray.forEach(row => {
                // ç¸½å’Œé¡
                stats.Move_Cal += parseFloat(row.Move_Cal) || 0;
                stats.Exercise_Min += parseFloat(row.Exercise_Min) || 0;
                stats.Stand_Hr += parseFloat(row.Stand_Hr) || 0;
                stats.Steps += parseFloat(row.Steps) || 0;
                stats.Distance += parseFloat(row.Distance) || 0;

                // å¹³å‡é¡ (å…ˆç´¯åŠ ï¼Œè¦æ³¨æ„æ’é™¤ 0 æˆ–ç©ºå€¼)
                if(row.Sleep_Hr > 0) { stats.Sleep_Hr += parseFloat(row.Sleep_Hr); sleepCount++; }
                if(row.RHR > 0) { stats.RHR += parseFloat(row.RHR); rhrCount++; }
                if(row.SpO2 > 0) { stats.SpO2 += parseFloat(row.SpO2); spo2Count++; }
                if(row.Walking_Speed > 0) { stats.Walking_Speed += parseFloat(row.Walking_Speed); speedCount++; }
            });

            // è¨ˆç®—å¹³å‡
            if(sleepCount > 0) stats.Sleep_Hr = (stats.Sleep_Hr / sleepCount).toFixed(1);
            if(rhrCount > 0) stats.RHR = Math.round(stats.RHR / rhrCount);
            if(spo2Count > 0) stats.SpO2 = (stats.SpO2 / spo2Count).toFixed(1); // é€™è£¡æ”¹ç”¨ SpO2
            if(speedCount > 0) stats.Walking_Speed = (stats.Walking_Speed / speedCount).toFixed(1);

            // ç¸½å’Œé¡å–æ•´æ•¸æˆ–å°æ•¸
            stats.Distance = stats.Distance.toFixed(1);
            
            // å¿ƒæƒ…é¡¯ç¤ºæœ€å¾Œä¸€å¤©çš„ï¼Œæˆ–æ˜¯ç©ºç™½
            stats.Mood = dataArray[dataArray.length-1].Mood;

            return stats;
        }

        function updateBadgeDisplay(displayStyle) {
            document.querySelectorAll('.stat-type').forEach(el => el.style.display = displayStyle);
        }

        function renderDashboard(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';

            updateVal('val_move', data.Move_Cal);
            updateVal('val_exercise', data.Exercise_Min);
            updateVal('val_stand', data.Stand_Hr);
            updateVal('val_steps', data.Steps);
            updateVal('val_dist', data.Distance);
            updateVal('val_sleep', data.Sleep_Hr);
            updateVal('val_rhr', data.RHR);
            updateVal('val_spo2', data.SpO2); // ä¿®æ­£è®Šæ•¸åç¨±
            updateVal('val_speed', data.Walking_Speed);
            updateVal('val_mood', data.Mood);
        }

        function updateVal(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerText = (value && value !== "" && value != 0) ? value : "--";
            }
        }

        function showError(title, message) {
            const el = document.getElementById('loading');
            el.innerHTML = `<strong style="color: #ff3b30; font-size: 18px;">âš ï¸ ${title}</strong><br><span style="color: #ccc;">${message}</span>`;
        }

        window.switchView = switchView; // ç¢ºä¿å…¨åŸŸå¯å‘¼å«
        init();
    </script>
</body>
</html>